{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block content %}
<div class="mx-4 sm:mx-6 lg:mx-auto p-6 max-w-7xl">

    <h1 class="text-2xl font-bold mb-6">{% trans "Marques de voiture" %}</h1>

    <!-- Section Mes favoris -->
    <div id="favoris-section" class="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4 {% if not favoris %}hidden{% endif %}">
        <h2 class="font-semibold text-yellow-600 mb-2">⭐ {% trans "Mes marques favorites" %}</h2>
        <div id="favoris-list" class="flex flex-wrap gap-4">
            {% for marque in favoris %}
            <div class="flex items-center gap-2" data-marque-id="{{ marque.id_marque }}">
                <span>{{ marque.nom_marque }}</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24"
                     fill="blue" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M11.48 3.5a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442a.562.562 0 01.32.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0l-4.725 2.885a.562.562 0 01-.84-.61l1.285-5.385a.563.563 0 00-.182-.557l-4.204-3.602a.562.562 0 01.32-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/>
                </svg>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Liste complète des marques -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 gap-6">
        {% for marque in marques %}
        <div class="bg-white shadow-md rounded-lg p-6 marque-card relative cursor-pointer"
             onclick="window.location.href='/voiture/marque/{{ marque.id_marque }}/modeles/'">

            <!-- Texte -->
            <div>
                <h2 class="text-lg font-semibold">{{ marque.nom_marque }}</h2>
                <p class="text-gray-600">{% trans "Voir les modèles de cette marque" %}</p>
            </div>

            <!-- Bouton étoile absolu -->
            <button class="star-btn w-10 h-10 flex items-center justify-center rounded-full bg-white shadow hover:scale-105 transition-transform duration-200 z-20"
                    onclick="event.stopPropagation(); toggleFavori(event, '{{ marque.id_marque }}')">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6"
                     viewBox="0 0 24 24"
                     fill="{% if marque.est_favori %}blue{% else %}yellow{% endif %}"
                     stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M11.48 3.5a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442a.562.562 0 01.32.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0l-4.725 2.885a.562.562 0 01-.84-.61l1.285-5.385a.563.563 0 00-.182-.557l-4.204-3.602a.562.562 0 01.32-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/>
                </svg>
            </button>


        </div>
        {% endfor %}
    </div>

</div>

<!-- jQuery local -->
<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>

<script>
function toggleFavori(event, id_marque) {
    event.stopPropagation();
    const btn = $(event.currentTarget);
    const icon = btn.find("svg");
    const card = btn.closest(".marque-card");
    const nomMarque = card.find("h2").text();

    $.post("/voiture/marque/" + id_marque + "/favori/", {
        csrfmiddlewaretoken: "{{ csrf_token }}"
    }, function(data) {
        const favorisSection = $("#favoris-section");
        const favorisList = $("#favoris-list");

        if (data.status === "added") {
            icon.attr("fill", "blue").attr("stroke", "none");

            if (favorisList.find(`[data-marque-id='${id_marque}']`).length === 0) {
                const favBadge = $(`
                    <div class="flex items-center gap-2" data-marque-id="${id_marque}">
                        <span>${nomMarque}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="blue" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M11.48 3.5a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442a.562.562 0 01.32.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0l-4.725 2.885a.562.562 0 01-.84-.61l1.285-5.385a.563.563 0 00-.182-.557l-4.204-3.602a.562.562 0 01.32-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/>
                        </svg>
                    </div>
                `);
                favorisList.append(favBadge);
            }
            favorisSection.show();
        } else {
            icon.attr("fill", "yellow").attr("stroke", "currentColor");
            favorisList.find(`[data-marque-id='${id_marque}']`).remove();
            if (favorisList.children().length === 0) favorisSection.hide();
        }
    });
}

$(document).ready(function(){
    console.log("jQuery fonctionne !");
});
</script>
{% endblock %}
