{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<div class="mx-4 sm:mx-6 lg:mx-auto p-6 max-w-7xl">

    <h1 class="text-2xl font-bold mb-6">
        {% trans "Marques de voiture" %}
    </h1>

    <!-- ‚≠ê Section Favoris -->
    <div id="favoris-section"
         class="sticky top-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 hidden">
        <h2 class="font-semibold text-yellow-600 mb-2">
            ‚≠ê {% trans "Mes marques favorites" %}
        </h2>
        <div id="favoris-list" class="flex flex-wrap gap-2"></div>
    </div>

    <!-- Grille des marques -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 gap-6">

        {% for marque in marques %}
        <!-- Carte Marque -->
        <div
            class="relative bg-white shadow-md rounded-lg p-6 w-full transition duration-300 hover:shadow-lg hover:bg-blue-50 cursor-pointer marque-card"
            data-marque-id="{{ marque.id_marque }}"
            onclick="window.location.href='{% url 'marque:liste_voitures_marque' marque.id_marque %}'"
        >

            <!-- ‚≠ê √âtoile Favori -->
            <button
                class="absolute top-3 right-3 z-10 star-btn text-yellow-400 transition"
                onclick="toggleFavori(event, {{ marque.id_marque }})"
                aria-label="{% trans 'Ajouter aux favoris' %}"
            >
                <svg xmlns="http://www.w3.org/2000/svg"
                     viewBox="0 0 24 24"
                     class="w-6 h-6 star-icon
                     {% if marque.est_favori %}
                         fill-yellow-400
                     {% else %}
                         fill-none stroke-yellow-400
                     {% endif %}"
                     stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442a.562.562 0 01.32.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0l-4.725 2.885a.562.562 0 01-.84-.61l1.285-5.385a.563.563 0 00-.182-.557l-4.204-3.602a.562.562 0 01.32-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/>
                </svg>
            </button>

            <!-- üìå Badge Favori -->
            <span class="favori-badge {% if not marque.est_favori %}hidden{% endif %}
                  absolute top-3 left-3 bg-yellow-400 text-white text-xs px-2 py-1 rounded">
                ‚≠ê Favori
            </span>

            <!-- Contenu -->
            <h2 class="text-lg font-semibold mb-2">
                {{ marque.nom_marque }}
            </h2>
            <p class="text-gray-600">
                {% trans "Voir les mod√®les de cette marque" %}
            </p>
        </div>
        {% empty %}
        <p class="text-gray-500 col-span-full">
            {% trans "Aucune marque trouv√©e." %}
        </p>
        {% endfor %}

    </div>
</div>

<!-- ‚≠ê Animation -->
<style>
@keyframes pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); }
    100% { transform: scale(1); }
}
.star-pop {
    animation: pop 0.3s ease-in-out;
}
</style>

<!-- üîÑ JS Favoris -->
<script>
function toggleFavori(event, marqueId) {
    event.stopPropagation();

    const btn = event.currentTarget;
    const icon = btn.querySelector(".star-icon");
    const card = btn.closest(".marque-card");
    const badge = card.querySelector(".favori-badge");

    fetch(`/voiture/marque/${marqueId}/favori/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
        }
    })
    .then(res => res.json())
    .then(data => {

        icon.classList.add("star-pop");
        setTimeout(() => icon.classList.remove("star-pop"), 300);

        if (data.status === "added") {
            icon.classList.remove("fill-none", "stroke-yellow-400");
            icon.classList.add("fill-yellow-400");
            badge.classList.remove("hidden");
        } else {
            icon.classList.remove("fill-yellow-400");
            icon.classList.add("fill-none", "stroke-yellow-400");
            badge.classList.add("hidden");
        }

        updateFavorisSection(marqueId, data.status);
    });
}

function updateFavorisSection(marqueId, status) {
    const favorisSection = document.getElementById("favoris-section");
    const favorisList = document.getElementById("favoris-list");
    const card = document.querySelector(`[data-marque-id="${marqueId}"]`);
    const nom = card.querySelector("h2").innerText;

    if (status === "added") {
        const item = document.createElement("span");
        item.className = "bg-yellow-400 text-white text-xs px-3 py-1 rounded";
        item.dataset.marqueId = marqueId;
        item.innerText = nom;
        favorisList.appendChild(item);
        favorisSection.classList.remove("hidden");
    } else {
        const item = favorisList.querySelector(`[data-marque-id="${marqueId}"]`);
        if (item) item.remove();
        if (!favorisList.children.length) {
            favorisSection.classList.add("hidden");
        }
    }
}
</script>

{% endblock %}
