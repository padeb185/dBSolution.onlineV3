{% extends "base.html" %}
{% load i18n static %}

{% block content %}
<div class="max-w-xl mx-auto p-6 bg-white rounded shadow mt-16 mb-16">

    <!-- Titre avec icône -->
    <h1 class="text-2xl font-bold mb-4 text-center flex items-center justify-center">
        <img src="{% static 'icons/voiture-de-course.png' %}" alt="Modele" style="width:60px; height:60px; margin-right:10px;">
        {% trans "Ajouter un modele de voiture" %}
    </h1>

   {% if messages %}
        {% for message in messages %}
            <div class="mb-3 px-4 py-2 rounded
                {% if message.tags == 'success' %}
                    bg-green-100 text-green-800 border border-green-300
                {% else %}
                    bg-red-100 text-red-800 border border-red-300
                {% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}


    <form method="post" class="flex flex-col space-y-4">
        {% csrf_token %}

        <!-- Motoriste -->
        <div class="flex flex-col">
            <label for="id_nom_marque" class="mb-1 font-medium">{% trans "Marque" %}</label>
            <input type="text" id="id_nom_marque" name="nom_marque"
                   class="border border-gray-300 rounded px-4 py-2 w-full"
                   placeholder="{% trans 'Nom de la marque' %}">
        </div>

        <!-- Modele -->
        <div class="flex flex-col">
            <label for="id_modele" class="mb-1 font-medium">{% trans "Modèle" %}</label>
            <input type="text" id="id_modele" name="modele"
                   class="border border-gray-300 rounded px-4 py-2 w-full"
                   placeholder="{% trans 'Nom du modèle' %}">
        </div>

        <!-- Code moteur -->
        <div class="flex flex-col">
            <label for="id_nom_variante" class="mb-1 font-medium">{% trans "Variante" %}</label>
            <input type="text" id="id_nom_variante" name="nom_variante"
                   class="border border-gray-300 rounded px-4 py-2 w-full"
                   placeholder="{% trans 'Nom de la variante' %}">
        </div>


        <!-- Nombre de portes -->
        <div class="flex flex-col">
            <label for="id_nombre_portes" class="mb-1 font-medium">{% trans "Nombre de portes" %}</label>
            <input type="text" id="id_nombre_portes" name="nombre_portes"
                   class="border border-gray-300 rounded px-4 py-2 w-full"
                   placeholder="{% trans 'Ex: 5' %}">
        </div>

        <!-- nombre de places -->
        <div class="flex flex-col">
            <label for="id_nbre_places" class="mb-1 font-medium">{% trans "Nombre de places" %}</label>
            <input type="number" step="0.01" id="id_nbre_places" name="nbre_places"
                   class="border border-gray-300 rounded px-4 py-2 w-full"
                   placeholder="Ex: 2">
        </div>

        <!-- taille_reservoir -->
        <div class="flex flex-col">
            <label for="id_taille_reservoir" class="mb-1 font-medium">{% trans "Taille du réservoir el litres" %}</label>
            <input type="text" id="id_taille_reservoir" name="taille_reservoir"
                   class="border border-gray-300 rounded px-4 py-2 w-full"
                   placeholder="{% trans '50' %}">
        </div>

        <!-- capacite_batterie -->
        <div class="flex flex-col">
            <label for="id_capacite_batterie" class="mb-1 font-medium">{% trans "Capacité de la batterie en kWh" %}</label>
            <input type="number" id="id_capacite_batterie" name="capacite_batterie"
                   class="border border-gray-300 rounded px-4 py-2 w-full"
                   placeholder="Ex: 90">
        </div>




        <!-- Bouton -->
        <button type="submit"
                class="mt-4 bg-blue-600 text-white px-4 py-2 rounded w-full hover:bg-blue-700 transition">
            {% trans "Ajouter" %}
        </button>
    </form>
</div>
<script>
    // Fonction pour récupérer le cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // On cible le champ "Marque"
    const nomMarqueField = document.getElementById('id_nom_marque');
    if (nomMarqueField) {
        nomMarqueField.addEventListener('change', function(){
            const motoriste = this.value;

            fetch('/api/check_nom', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({motoriste: motoriste})
            })
            .then(response => response.json())
            .then(data => {
                // Remplir les champs seulement s'ils existent dans le DOM
                const mapping = {
                    'id_nom_marque': data.voiture_marque,
                    'id_modele': data.voiture_modele,
                    'id_nom_variante': data.nom_variante,
                    'id_nombre_portes': data.nombre_portes,
                    'id_nbre_places': data.nbre_places,
                    'id_taille_reservoir': data.taille_reservoir,
                    'id_capacite_batterie': data.capacite_batterie
                };

                for (const [fieldId, value] of Object.entries(mapping)) {
                    const el = document.getElementById(fieldId);
                    if (el) {
                        el.value = value || '';
                    }
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
            });
        });
    }
</script>
{% endblock %}

