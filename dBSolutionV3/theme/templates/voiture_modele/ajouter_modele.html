{% extends "base.html" %}
{% load i18n static widget_tweaks %}

{% block content %}
<div class="max-w-xl mx-auto p-6 bg-white rounded shadow mt-16 mb-16">

    <!-- Titre avec icône -->
    <h1 class="text-2xl font-bold mb-4 text-center flex items-center justify-center">
        <img src="{% static 'icons/voiture-de-course.png' %}" alt="Modele" style="width:60px; height:60px; margin-right:10px;">
        {% trans "Ajouter un modèle de voiture" %}
    </h1>

    <!-- Messages Django -->
   {% if messages %}
        {% for message in messages %}
            <div class="mb-3 px-4 py-2 rounded
                {% if message.tags == 'success' %}
                    bg-green-100 text-green-800 border border-green-300
                {% else %}
                    bg-red-100 text-red-800 border border-red-300
                {% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Erreurs globales du formulaire -->
    {% if form.non_field_errors %}
        <div class="mb-3 px-4 py-2 rounded bg-red-100 text-red-800 border border-red-300">
            {% for error in form.non_field_errors %}
                <p>{{ error }}</p>
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" class="flex flex-col space-y-4">
        {% csrf_token %}

        <!-- Marque -->
        <div class="flex flex-col">
            <label for="{{ form.voiture_marque.id_for_label }}" class="mb-1 font-medium">{% trans "Marque" %}</label>
            {{ form.voiture_marque|add_class:"border border-gray-300 rounded px-4 py-2 w-full" }}
            {% for error in form.voiture_marque.errors %}
                <span class="text-red-600 text-sm mt-1">{{ error }}</span>
            {% endfor %}
        </div>

        <!-- Modèle -->
        <div class="flex flex-col">
            <label for="{{ form.nom_modele.id_for_label }}" class="mb-1 font-medium">{% trans "Modèle" %}</label>
            {{ form.nom_modele|add_class:"border border-gray-300 rounded px-4 py-2 w-full" }}
            {% for error in form.nom_modele.errors %}
                <span class="text-red-600 text-sm mt-1">{{ error }}</span>
            {% endfor %}
        </div>

        <!-- Variante -->
        <div class="flex flex-col">
            <label for="{{ form.nom_variante.id_for_label }}" class="mb-1 font-medium">{% trans "Variante" %}</label>
            {{ form.nom_variante|add_class:"border border-gray-300 rounded px-4 py-2 w-full" }}
            {% for error in form.nom_variante.errors %}
                <span class="text-red-600 text-sm mt-1">{{ error }}</span>
            {% endfor %}
        </div>

        <!-- Nombre de portes -->
        <div class="flex flex-col">
            <label for="{{ form.nombre_portes.id_for_label }}" class="mb-1 font-medium">{% trans "Nombre de portes" %}</label>
            {{ form.nombre_portes|add_class:"border border-gray-300 rounded px-4 py-2 w-full" }}
            {% for error in form.nombre_portes.errors %}
                <span class="text-red-600 text-sm mt-1">{{ error }}</span>
            {% endfor %}
        </div>

        <!-- Nombre de places -->
        <div class="flex flex-col">
            <label for="{{ form.nbre_places.id_for_label }}" class="mb-1 font-medium">{% trans "Nombre de places" %}</label>
            {{ form.nbre_places|add_class:"border border-gray-300 rounded px-4 py-2 w-full" }}
            {% for error in form.nbre_places.errors %}
                <span class="text-red-600 text-sm mt-1">{{ error }}</span>
            {% endfor %}
        </div>

        <!-- Taille du réservoir -->
        <div class="flex flex-col">
            <label for="{{ form.taille_reservoir.id_for_label }}" class="mb-1 font-medium">{% trans "Taille du réservoir en litres" %}</label>
            {{ form.taille_reservoir|add_class:"border border-gray-300 rounded px-4 py-2 w-full" }}
            {% for error in form.taille_reservoir.errors %}
                <span class="text-red-600 text-sm mt-1">{{ error }}</span>
            {% endfor %}
        </div>

        <!-- Capacité de batterie -->
        <div class="flex flex-col">
            <label for="{{ form.capacite_batterie.id_for_label }}" class="mb-1 font-medium">{% trans "Capacité de la batterie en kWh" %}</label>
            {{ form.capacite_batterie|add_class:"border border-gray-300 rounded px-4 py-2 w-full" }}
            {% for error in form.capacite_batterie.errors %}
                <span class="text-red-600 text-sm mt-1">{{ error }}</span>
            {% endfor %}
        </div>

        <!-- Bouton -->
        <button type="submit"
                class="mt-4 bg-blue-600 text-white px-4 py-2 rounded w-full hover:bg-blue-700 transition">
            {% trans "Ajouter" %}
        </button>
    </form>
</div>

<script>
    // Fonction pour récupérer le cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // Exemple: préremplir les champs si nécessaire
    const marqueField = document.getElementById('id_voiture_marque');
    if (marqueField) {
        marqueField.addEventListener('change', function(){
            const marque = this.value;

            fetch('/api/check_nom', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({marque: marque})
            })
            .then(response => response.json())
            .then(data => {
                const mapping = {
                    'id_nom_modele': data.nom_modele,
                    'id_nom_variante': data.nom_variante,
                    'id_nombre_portes': data.nombre_portes,
                    'id_nbre_places': data.nbre_places,
                    'id_taille_reservoir': data.taille_reservoir,
                    'id_capacite_batterie': data.capacite_batterie
                };

                for (const [fieldId, value] of Object.entries(mapping)) {
                    const el = document.getElementById(fieldId);
                    if (el) el.value = value || '';
                }
            })
            .catch(error => console.error('Erreur:', error));
        });
    }
</script>
{% endblock %}