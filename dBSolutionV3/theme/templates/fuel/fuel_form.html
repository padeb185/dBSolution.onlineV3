{% extends "base.html" %}
{% load i18n static %}

{% block content %}
<div class="max-w-xl mx-auto p-6 bg-white rounded shadow mt-16 mb-16">

    <!-- Header -->
    <h1 class="text-2xl font-bold mb-4 text-center flex items-center justify-center">
        <img src="{% static 'icons/pompe-a-essence.png' %}"
             style="width:75px; margin-right:5px;"
             alt="{% trans 'Carburant' %}">
        {% trans "Ajouter du carburant" %}
    </h1>

    {% if messages %}
        {% for message in messages %}
            <div class="mb-3 px-4 py-2 rounded
                {% if message.tags == 'success' %}
                    bg-green-100 text-green-800 border border-green-300
                {% else %}
                    bg-red-100 text-red-800 border border-red-300
                {% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" class="flex flex-col space-y-4">
        {% csrf_token %}

        <!-- Masqué : voiture_exemplaire -->
        <input type="hidden" id="id_voiture_exemplaire" name="voiture_exemplaire"
               value="{{ request.POST.voiture_exemplaire|default:fuel.voiture_exemplaire.id|default:'' }}">

        <!-- Immatriculation -->
        <div>
            <label for="id_immatriculation">{% trans "Immatriculation" %}</label>
            <input type="text" id="id_immatriculation" name="immatriculation"
                   value="{{ request.POST.immatriculation|default:fuel.immatriculation|default:'' }}"
                   class="border rounded px-4 py-2 w-full">
        </div>

        <!-- Type de carburant -->
        <div>
            <label for="id_type_carburant">{% trans "Type de carburant" %}</label>
            <select id="id_type_carburant" name="type_carburant"
                    class="border rounded px-4 py-2 w-full">
                {% for key, label in type_carburant_choices %}
                    <option value="{{ key }}"
                        {% if request.POST.type_carburant == key or fuel.type_carburant == key %}selected{% endif %}>
                        {{ label }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Date -->
        <div>
            <label for="id_date">{% trans "Date du plein" %}</label>
            <input type="date" id="id_date" name="date"
                   value="{{ request.POST.date|default:fuel.date|default:'' }}"
                   class="border rounded px-4 py-2 w-full">
        </div>

        <!-- Litres -->
        <div>
            <label for="id_litres">{% trans "Litres" %}</label>
            <input type="number" step="0.01" id="id_litres" name="litres"
                   value="{{ request.POST.litres|default:fuel.litres|default:'' }}"
                   class="border rounded px-4 py-2 w-full">
        </div>

        <!-- Prix du plein -->
        <div>
            <label for="id_prix_refuelling">{% trans "Prix du plein (€)" %}</label>
            <input type="number" step="0.01" id="id_prix_refuelling" name="prix_refuelling"
                   value="{{ request.POST.prix_refuelling|default:fuel.prix_refuelling|default:'' }}"
                   class="border rounded px-4 py-2 w-full">
        </div>

        <!-- Champs readonly -->
        <div>
            <label for="id_voiture_marque">{% trans "Marque" %}</label>
            <input type="text" id="id_voiture_marque" name="voiture_marque"
                   value="{{ fuel.voiture_exemplaire.voiture_modele.voiture_marque.nom_marque|default:'' }}"
                   class="border rounded px-4 py-2 w-full bg-gray-100 cursor-not-allowed" disabled>
        </div>

        <div>
            <label for="id_voiture_modele">{% trans "Modèle" %}</label>
            <input type="text" id="id_voiture_modele" name="voiture_modele"
                   value="{{ fuel.voiture_exemplaire.voiture_modele.nom_modele|default:'' }}"
                   class="border rounded px-4 py-2 w-full bg-gray-100 cursor-not-allowed" disabled>
        </div>

        <div>
            <label for="id_taille_reservoir_display">{% trans "Volume max (L)" %}</label>
            <input type="number" id="id_taille_reservoir_display" name="taille_reservoir_display"
                   value="{{ fuel.voiture_exemplaire.voiture_modele.taille_reservoir|default:'' }}"
                   class="border rounded px-4 py-2 w-full bg-gray-100 cursor-not-allowed" disabled>
        </div>

        <div>
            <label for="id_pays">{% trans "Pays" %}</label>
            <select id="id_pays" name="pays"
                    class="border rounded px-4 py-2 w-full">
                <option value="" {% if not fuel.pays %}selected{% endif %}>-- Choisir un pays --</option>
                <option value="BE" {% if fuel.pays == "BE" %}selected{% endif %}>Belgique</option>
                <option value="LU" {% if fuel.pays == "LU" %}selected{% endif %}>Luxembourg</option>
                <option value="DE" {% if fuel.pays == "DE" %}selected{% endif %}>Allemagne</option>
            </select>
        </div>

         <!-- Validation -->
        <div>
            <label for="id_validation">{% trans "Validation" %}</label>
            <input type="checkbox" id="id_validation" name="validation"
                   {% if request.POST.validation or fuel.validation %}checked{% endif %}
                   class="rounded">
        </div>

        <div class="mt-4">
            <button type="submit"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                {% trans "Enregistrer" %}
            </button>
            <a href="{% url 'fuel:fuel_list' %}"
               class="ml-2 text-gray-600 hover:text-gray-800 font-semibold">{% trans "Annuler" %}</a>
        </div>

    </form>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie) {
        document.cookie.split(';').forEach(c => {
            c = c.trim();
            if (c.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(c.slice(name.length + 1));
            }
        });
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

document.addEventListener("DOMContentLoaded", function () {

    // -----------------------------
    // Auto-completion immatriculation
    // -----------------------------
    const immatInput = document.getElementById("id_immatriculation");
    if (immatInput) {
        immatInput.addEventListener("input", function () {
            const value = this.value;
            if (value.length < 2) return; // éviter les requêtes inutiles

            fetch(`/fuel/ajax/check-immatriculation/?immatriculation=${value}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.error) {
                        // remplir le champ caché obligatoire
                        document.getElementById("id_voiture_exemplaire").value = data.id;

                        // remplir les champs readonly
                        document.getElementById("id_voiture_marque").value = data.marque;
                        document.getElementById("id_voiture_modele").value = data.modele;
                        document.getElementById("id_taille_reservoir_display").value = data.volume;
                    } else {
                        document.getElementById("id_voiture_exemplaire").value = "";
                        document.getElementById("id_voiture_marque").value = "";
                        document.getElementById("id_voiture_modele").value = "";
                        document.getElementById("id_taille_reservoir_display").value = "";
                    }
                })
                .catch(err => console.error("Erreur:", err));
        });
    }

    // -----------------------------
    // Auto-complétion marque et modèle (optionnel)
    // -----------------------------
    const marqueInput = document.getElementById("id_voiture_marque");
    const modeleInput = document.getElementById("id_voiture_modele");

    if (marqueInput && modeleInput) {
        // Auto-complétion marque
        marqueInput.addEventListener("input", function () {
            const query = this.value;
            fetch(`/fuel/ajax/get-marques/?q=${query}`)
                .then(r => r.json())
                .then(data => {
                    const list = document.getElementById("marque-list");
                    if (list) {
                        list.innerHTML = "";
                        data.forEach(item => {
                            const option = document.createElement("option");
                            option.value = item;
                            list.appendChild(option);
                        });
                    }
                })
                .catch(err => console.error("Erreur marques:", err));
        });

        // Auto-complétion modèle
        modeleInput.addEventListener("input", function () {
            const query = this.value;
            fetch(`/fuel/ajax/get-modeles/?q=${query}`)
                .then(r => r.json())
                .then(data => {
                    const list = document.getElementById("modele-list");
                    if (list) {
                        list.innerHTML = "";
                        data.forEach(item => {
                            const option = document.createElement("option");
                            option.value = item;
                            list.appendChild(option);
                        });
                    }
                })
                .catch(err => console.error("Erreur modèles:", err));
        });
    }

});
</script>
{% endblock %}