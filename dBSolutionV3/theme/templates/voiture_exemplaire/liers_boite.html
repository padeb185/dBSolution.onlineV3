{% extends "base.html" %}
{% load i18n %}

{% block content %}
<h2>{{ title }}</h2>

<form method="post" id="lier-boite-form">
    {% csrf_token %}

    <!-- Fabricant -->
    <label for="fabricant">Fabricant</label>
    <input type="text" id="fabricant" name="fabricant" autocomplete="off">

    <!-- Type de boîte -->
    <label for="type_de_boite">Type de boîte</label>
    <select id="type_de_boite" name="type_de_boite" disabled>
        <option value="">-- Choisir --</option>
    </select>

    <!-- Nom du type -->
    <label for="nom_du_type">Nom du type</label>
    <select id="nom_du_type" name="nom_du_type" disabled>
        <option value="">-- Choisir --</option>
    </select>

    <button type="submit">Lier la boîte</button>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {

    // --- Quand le fabricant change ---
    $("#fabricant").on("input", function() {
        var fabricant = $(this).val().trim();
        var selectType = $("#type_de_boite");
        var selectNom = $("#nom_du_type");

        selectType.empty().append('<option value="">-- Choisir --</option>').prop("disabled", true);
        selectNom.empty().append('<option value="">-- Choisir --</option>').prop("disabled", true);

        if (fabricant) {
            $.ajax({
                url: "{% url 'voiture_exemplaire:ajax_get_type_de_boite' %}",
                data: { fabricant: fabricant },
                success: function(data) {
                    if (data.length > 0) {
                        data.forEach(function(t) {
                            selectType.append('<option value="'+t+'">'+t+'</option>');
                        });
                        selectType.prop("disabled", false);
                    }
                }
            });
        }
    });

    // --- Quand le type de boîte change ---
    $("#type_de_boite").change(function() {
        var fabricant = $("#fabricant").val().trim();
        var type_de_boite = $(this).val();
        var selectNom = $("#nom_du_type");

        selectNom.empty().append('<option value="">-- Choisir --</option>').prop("disabled", true);

        if (fabricant && type_de_boite) {
            $.ajax({
                url: "{% url 'voiture_exemplaire:ajax_get_nom_du_type' %}",
                data: { fabricant: fabricant, type_de_boite: type_de_boite },
                success: function(data) {
                    if (data.length > 0) {
                        data.forEach(function(nom) {
                            selectNom.append('<option value="'+nom+'">'+nom+'</option>');
                        });
                        selectNom.prop("disabled", false);
                    } else if (data.nom_du_type) {
                        // Si le view renvoie un seul nom
                        selectNom.append('<option value="'+data.nom_du_type+'">'+data.nom_du_type+'</option>').prop("disabled", false);
                    }
                }
            });
        }
    });

});
</script>
{% endblock %}
