{% extends "base.html" %}
{% load i18n static %}
{% load widget_tweaks %}

{% block content %}
<div class="max-w-xl mx-auto p-6 bg-white rounded shadow mt-16 mb-16">
    <h1 class="text-2xl font-bold mb-4 text-center">
        {% trans "Ajouter un exemplaire pour" %} {{ modele.voiture_marque.nom_marque }} {{ modele.nom_modele }}
        {% if modele.nom_variante %} - {{ modele.nom_variante }}{% endif %}
    </h1>

    {% for message in messages %}
        <div class="mb-3 text-red-600">{{ message }}</div>
    {% endfor %}

    <form method="post" class="flex flex-col space-y-4">
        {% csrf_token %}
        {% if form.non_field_errors %}
            <div class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        {% for field in form %}
            <div class="flex flex-col">
                <label class="mb-1 font-medium {% if field.errors %}text-red-600{% endif %}">
                    {{ field.label }}
                </label>

                {% if field.errors %}
                    {{ field|add_class:"border border-red-500 rounded px-4 py-2 w-full" }}
                {% else %}
                    {{ field|add_class:"border border-gray-300 rounded px-4 py-2 w-full" }}
                {% endif %}

                {% if field.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ field.errors|striptags }}</p>
                {% endif %}
            </div>
        {% endfor %}


        <button type="submit" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded w-full hover:bg-blue-700 transition">
            {% trans "Ajouter" %}
        </button>
    </form>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

const marqueInput = document.getElementById('id_voiture_marque');

if (marqueInput) {
    marqueInput.addEventListener('change', function () {
        const voiture_marque = this.value;

        fetch('/api/check_nom', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({ voiture_marque: voiture_marque })
        })
        .then(response => response.json())
        .then(data => {
            if (data.exist) {
                document.getElementById('id_voiture_marque').value = data.voiture_marque;
                document.getElementById('id_voiture_modele').value = data.voiture_modele;
                document.getElementById('id_immatriculation').value = data.immatriculation;
                document.getElementById('id_numero_vin').value = data.numero_vin;
                document.getElementById('id_type_utilisation').value = data.type_utilisation;
            } else {
                document.getElementById('id_voiture_marque').value = '';
                document.getElementById('id_voiture_modele').value = '';
                document.getElementById('id_immatriculation').value = '';
                document.getElementById('id_numero_vin').value = '';
                document.getElementById('id_type_utilisation').value = '';
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
        });
    });
}
</script>

{% endblock %}
