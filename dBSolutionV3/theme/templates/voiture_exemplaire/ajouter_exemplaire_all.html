{% extends "base.html" %}
{% load i18n static %}
{% load widget_tweaks %}

{% block content %}
<div class="max-w-xl mx-auto p-6 bg-white rounded shadow mt-16 mb-16">

    <h1 class="text-2xl font-bold mb-4 text-center">
        {% trans "Ajouter un véhicule" %}
    </h1>

    {% if messages %}
        {% for message in messages %}
            <div class="mb-3 px-4 py-2 rounded
                {% if message.tags == 'success' %}
                    bg-green-100 text-green-800 border border-green-300
                {% else %}
                    bg-red-100 text-red-800 border border-red-300
                {% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" class="mt-6">
        {% csrf_token %}

        {% for field in form %}
            <label class="font-semibold">{{ field.label }}</label>
            {{ field|add_class:"input" }}
            {% if field.errors %}
                <div class="text-red-600 text-sm mb-2">{{ field.errors }}</div>
            {% endif %}
        {% endfor %}

        <!-- Année auto -->
        <label class="font-semibold">{% trans "Année de production" %}</label>
        <input type="number" id="id_annee_production" class="input" readonly>

        <div class="flex gap-2 mt-4">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded w-full">
                {% trans "Ajouter" %}
            </button>

            <a href="{% url 'voiture_exemplaire:voiture_exemplaire' modele_id=modele.id %}"
               class="bg-gray-300 text-black px-4 py-2 rounded hover:bg-gray-400">
                {% trans "Annuler" %}
            </a>
        </div>
    </form>
</div>

<style>
.input {
    width: 100%;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 8px;
    margin-bottom: 10px;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const VIN_YEAR_BASE = {
        "A":1980,"B":1981,"C":1982,"D":1983,"E":1984,"F":1985,"G":1986,"H":1987,
        "J":1988,"K":1989,"L":1990,"M":1991,"N":1992,"P":1993,"R":1994,"S":1995,
        "T":1996,"V":1997,"W":1998,"X":1999,"Y":2000,
        "1":2001,"2":2002,"3":2003,"4":2004,"5":2005,"6":2006,"7":2007,"8":2008,"9":2009
    };

    const INVALID_CHARS = ["I","O","Q"];

    const vinInput = document.getElementById("id_numero_vin");
    const anneeInput = document.getElementById("id_annee_production");
    const avant2010Checkbox = document.getElementById("id_est_avant_2010");
    const vinSimplifieInput = document.getElementById("id_vin_simplifie");

    if (!vinInput) return;

    vinInput.addEventListener("input", function () {
        let vin = vinInput.value.toUpperCase();
        vinInput.value = vin;

        if (vin.length === 17) {

            if (INVALID_CHARS.some(c => vin.includes(c))) {
                anneeInput.value = "";
                if (avant2010Checkbox) avant2010Checkbox.checked = false;
                return;
            }

            const code = vin[9];
            const year = VIN_YEAR_BASE[code] || "";

            if (anneeInput) anneeInput.value = year;

            if (avant2010Checkbox && year) {
                avant2010Checkbox.checked = year < 2010;
            }

            // VIN simplifié = 10 derniers caractères
            if (vinSimplifieInput) {
                vinSimplifieInput.value = vin.slice(-10);
            }

        } else {
            if (anneeInput) anneeInput.value = "";
            if (avant2010Checkbox) avant2010Checkbox.checked = false;
            if (vinSimplifieInput) vinSimplifieInput.value = "";
        }
    });

});
</script>

{% endblock %}