{% extends "base.html" %}
{% load i18n static %}

{% block content %}
<div class="max-w-xl mx-auto p-6 bg-white rounded shadow mt-16 mb-16">

    <h1 class="text-2xl font-bold mb-4 text-center flex items-center justify-center">
        {% with logo_path="exemplaires/"|add:modele.voiture_marque.nom_marque|lower|add:".png" %}
            <img src="{% static logo_path %}"
                 style="width:75px; margin-right:5px;"
                 onerror="this.onerror=null;this.src='{% static 'exemplaires/default.png' %}';"
                 alt="{{ modele.voiture_marque.nom_marque }}">
        {% endwith %}
        {% trans "Ajouter un véhicule : " %}
        {{ modele.voiture_marque.nom_marque }} {{ modele.nom_modele }}
        {% if modele.nom_variante %} - {{ modele.nom_variante }}{% endif %}
    </h1>


    {% for message in messages %}
        <div class="mb-3 text-red-600">{{ message }}</div>
    {% endfor %}

    <form method="post" class="flex flex-col space-y-4">
        {% csrf_token %}

        <div>
            <label for="id_voiture_marque">{% trans "Marque" %}</label>
            <input type="text" id="id_voiture_marque" name="voiture_marque" class="border rounded px-4 py-2 w-full">
        </div>

        <div>
            <label for="id_voiture_modele">{% trans "Modèle" %}</label>
            <input type="text" id="id_voiture_modele" name="voiture_modele" class="border rounded px-4 py-2 w-full">
        </div>

        <div>
            <label for="id_immatriculation">{% trans "Immatriculation" %}</label>
            <input type="text" id="id_immatriculation" name="immatriculation" class="border rounded px-4 py-2 w-full">
        </div>
         <div>
            <label for="id_pays">{% trans "Pays d'immatriculation" %}</label>
            <input type="text" id="id_pays" name="pays" class="border rounded px-4 py-2 w-full">
        </div>

        <div>
            <label for="id_numero_vin">{% trans "Numero VIN" %}</label>
            <input type="number" id="id_numero_vin" name="numero_vin" class="border rounded px-4 py-2 w-full">
        </div>

        <div>
            <label for="id_type_utilisation">{% trans "Type d'utilisation" %}</label>
            <input type="text" id="id_type_utilisation" name="type_utilisation" class="border rounded px-4 py-2 w-full">
        </div>

        <div>
            <label for="id_kilometres_chassis">{% trans "Kilomètres du chassis" %}</label>
            <input type="text" id="id_kilometres_chassis" name="kilometres_chassis" class="border rounded px-4 py-2 w-full">
        </div>

         <div>
            <label for="id_kilometres_derniere_intervention">{% trans "Kilomètres de la dernière intervention" %}</label>
            <input type="text" id="id_kilometres_derniere_intervention" name="kilometres_derniere_intervention" class="border rounded px-4 py-2 w-full">
        </div>

         <div>
            <label for="id_date_derniere_intervention">{% trans "Date de la dernière intervention" %}</label>
            <input type="text" id="id_date_derniere_intervention" name="date_derniere_intervention" class="border rounded px-4 py-2 w-full">
        </div>

         <div>
            <label for="id_annee_production">{% trans "Année de production" %}</label>
            <input type="text" id="id_annee_production" name="annee_production" class="border rounded px-4 py-2 w-full">
        </div>

        <div>
            <label for="id_mois_production">{% trans "Mois de production" %}</label>
            <input type="text" id="id_mois_production" name="mois_production" class="border rounded px-4 py-2 w-full">
        </div>

        <div>
            <label for="id_numero_moteur">{% trans "Numero d'identification du moteur" %}</label>
            <input type="text" id="id_numero_moteur" name="numero_moteur" class="border rounded px-4 py-2 w-full">
        </div>

        <div>
            <label for="id_date_mise_en_circulation">{% trans "Date de mise en circulation" %}</label>
            <input type="text" id="id_date_mise_en_circulation" name="date_mise_en_circulation" class="border rounded px-4 py-2 w-full">
        </div>

        <div>
            <label for="id_kilometres_moteur">{% trans "Kilomètres moteur" %}</label>
            <input type="text" id="id_kilometres_moteur" name="kilometres_moteur" class="border rounded px-4 py-2 w-full">
        </div>

        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded w-full">
            {% trans "Ajouter" %}
        </button>
    </form>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie) {
        document.cookie.split(';').forEach(c => {
            c = c.trim();
            if (c.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(c.slice(name.length + 1));
            }
        });
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

document.getElementById('id_voiture_marque').addEventListener('change', function(){
    const fabricant = this.value;

    fetch('/api/check_nom', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({ voiture_marque: voiture_marque })
    })
    .then(r => r.json())
    .then(data => {
        if (data.exist) {
            document.getElementById('id_voiture_marque').value = data.voiture_marque;
            document.getElementById('id_voiture_modele').value = data.voiture_modele;
            document.getElementById('id_immatriculation').value = data.immatriculation;
            document.getElementById('id_pays').value = data.pays;
            document.getElementById('id_numero_vin').value = data.numero_vin;
            document.getElementById('id_type_utilisation').value = data.type_utilisation;
            document.getElementById('id_kilometres_chassis').value = data.kilometres_chassis;
        } else {
            document.getElementById('id_voiture_modele').value = '';
            document.getElementById('id_immatriculation').value = '';
            document.getElementById('id_pays').value = '';
            document.getElementById('id_numero_vin').value = '';
            document.getElementById('id_type_utilisation').value = '';
            document.getElementById('id_kilometres_chassis').value = '';
        }
    })
    .catch(err => console.error("Erreur:", err));
});
</script>
{% endblock %}
