{% load static i18n widget_tweaks %}
{% get_current_language as LANGUAGE_CODE %}

<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% trans "dBSolution" %}{% endblock %}</title>

    <!-- CSS Tailwind + custom -->
    <link rel="stylesheet" href="{% static 'theme/css/dist/styles.css' %}">
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <link rel="icon" type="image/png" href="{% static 'images/favicon.ico' %}">

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
</head>

<body class="{% block body_class %}bg-pastelblue min-h-screen flex flex-col mx-[50px]{% endblock %}">

<!-- PAGE LOADER GLOBAL -->
<div id="page-loader" class="fixed inset-0 bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center z-[9999]">
  <div class="text-center font-sans text-blue-900">

    <!-- KPI ICON -->
    <div class="relative w-20 h-20 mx-auto mb-5 rounded-2xl bg-gradient-to-br from-blue-200 via-blue-300 to-blue-400 overflow-hidden">
      <div class="absolute bottom-4 left-[22px] w-1.5 h-4 bg-white rounded-[3px] opacity-90 animate-barAnim delay-0"></div>
      <div class="absolute bottom-4 left-[36px] w-1.5 h-7 bg-white rounded-[3px] opacity-90 animate-barAnim delay-200"></div>
      <div class="absolute bottom-4 left-[50px] w-1.5 h-9 bg-white rounded-[3px] opacity-90 animate-barAnim delay-400"></div>
      <svg class="absolute top-0 left-0 w-full h-full" viewBox="0 0 80 80">
        <path d="M10 55 C30 25, 50 65, 70 30" class="stroke-blue-600 stroke-1.5 fill-none animate-draw"/>
      </svg>
    </div>

    <!-- Loader Text -->
    <div class="text-gray-400 text-sm">Chargement des données…</div>

    <!-- Progress Bar -->
    <div class="mt-5 w-56 h-1.5 bg-gray-200 rounded-full overflow-hidden">
      <div class="h-full bg-gradient-to-r from-blue-600 to-sky-400 rounded-full animate-progress"></div>
    </div>

  </div>
</div>

{% block header %}
<header class="bg-white shadow p-4 m-0">
  <nav class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4 md:gap-0">
    <div class="flex gap-4 items-center">
      <a href="{% url 'home' %}" class="text-gray-600 hover:text-black font-semibold transition duration-300">{% trans "Accueil" %}</a>
      <a href="{% url 'utilisateurs:dashboard' %}" class="text-gray-600 hover:text-black font-semibold transition duration-300">{% trans "Tableau de Bord" %}</a>
    </div>

    <form action="{% url 'set_language' %}" method="post" class="flex items-center gap-2 mt-2 md:mt-0">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.path }}">
      <select name="language" class="border rounded p-1 focus:ring-2 focus:ring-blue-500 focus:outline-none">
        {% get_available_languages as LANGUAGES %}
        {% for code, name in LANGUAGES %}
          <option value="{{ code }}" {% if code == LANGUAGE_CODE %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="bg-blue-700 text-white px-2 py-1 rounded hover:bg-blue-400 transition duration-300">{% trans "Changer" %}</button>
    </form>
  </nav>
</header>
{% endblock %}

<main class="{% block main_class %}container mx-auto p-6 flex-1{% endblock %}">
  {% block content %}{% endblock %}
</main>

{% block footer %}
<footer class="bg-white shadow p-4 mt-auto text-gray-500 flex items-center justify-between m-0">
  <div class="flex-shrink-0">
    <button type="button" onclick="history.back()" class="bg-blue-700 text-white px-3 py-1 rounded hover:bg-blue-400 transition duration-300">{% trans "Retour" %}</button>
  </div>

  <div class="flex-1 text-center">
    &copy; {{ now|date:"Y" }} dBSolution. {% trans "Tous droits réservés." %}
  </div>

  <div class="flex-shrink-0">
    {% if request.user.is_authenticated %}
      <form action="{% url 'utilisateurs:logout' %}" method="post">
        {% csrf_token %}
        <button type="submit" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition duration-300">{% trans "Déconnexion" %}</button>
      </form>
    {% endif %}
  </div>
</footer>
{% endblock %}

<!-- DUMMY POUR SAFELIST -->
<div class="hidden bg-red-500 bg-blue-600 hover:bg-blue-700 text-gray-700 text-gray-500 border border-gray-300 px-4 py-2 rounded shadow-md flex flex-col items-center justify-center min-h-screen w-full"></div>

<!-- Loader JS -->
<script>
  window.addEventListener("load", function () {
    const loader = document.getElementById("page-loader");
    loader.classList.add('opacity-0', 'transition-opacity', 'duration-400');
    setTimeout(() => loader.remove(), 400);
  });
</script>
</body>
</html>