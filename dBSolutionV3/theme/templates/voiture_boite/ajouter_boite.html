{% extends "base.html" %}
{% load i18n static widget_tweaks %}

{% block content %}
<div class="max-w-xl mx-auto p-6 bg-white rounded shadow mt-16 mb-16">

    <!-- Titre -->
    <h1 class="text-2xl font-bold mb-4 text-center">
        {% trans "Ajouter une boite de vitesse pour" %} {{ modele.voiture_marque.nom_marque }} {{ modele.nom_modele }}
        {% if modele.nom_variante %} - {{ modele.nom_variante }} {% endif %}
    </h1>

    <!-- Messages généraux -->
    {% if messages %}
        {% for message in messages %}
            <div class="mb-3 p-3 rounded
                {% if message.tags == 'success' %}bg-green-100 border border-green-400 text-green-700{% endif %}
                {% if message.tags == 'error' %}bg-red-100 border border-red-400 text-red-700{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Formulaire -->
    <form method="post" class="flex flex-col space-y-4">
        {% csrf_token %}

        {% if form.errors %}
            <div class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                {% trans "Veuillez corriger les erreurs ci-dessous." %}
            </div>
        {% endif %}

        {% for field in form %}
            <div class="flex flex-col">
                <label class="mb-1 font-medium {% if field.errors %}text-red-600{% endif %}">
                    {{ field.label }}
                </label>

                {{ field|add_class:"px-4 py-2 rounded w-full"
                          |add_class_if:field.errors:"border border-red-500"
                          |add_class_if:not field.errors:"border border-gray-300" }}

                {% if field.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ field.errors|striptags }}</p>
                {% endif %}
            </div>
        {% endfor %}

        <button type="submit" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded w-full hover:bg-blue-700 transition">
            {% trans "Ajouter" %}
        </button>
    </form>
</div>

<!-- JS pour pré-remplissage automatique -->
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

const marqueInput = document.getElementById('id_voiture_marque');

if (marqueInput) {
    marqueInput.addEventListener('change', function () {
        const voiture_marque = this.value;

        fetch('/api/check_nom', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({ voiture_marque: voiture_marque })
        })
        .then(response => response.json())
        .then(data => {
            // Corrigé : noms des champs cohérents avec le formulaire
            const fieldsMap = {
                'voiture_modele': 'id_voiture_modele',
                'nom_du_type': 'id_nom_du_type',
                'type': 'id_type_de_boite',
                'nombre_rapport': 'id_nombre_rapports'
            };

            for (const key in fieldsMap) {
                const el = document.getElementById(fieldsMap[key]);
                if (el) el.value = data.exist ? data[key] : '';
            }
        })
        .catch(error => console.error('Erreur:', error));
    });
}
</script>
{% endblock %}
